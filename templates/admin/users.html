{% extends "base/base.html" %}

{% block title %}ONA - Gestion des Utilisateurs{% endblock %}

{% block content %}

<div class="container-fluid mt-4">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <h2 class="mb-0">
                    <i class="fas fa-users me-2 text-primary"></i>
                    <span class="gradient-text">Gestion des Utilisateurs</span>
                </h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="{{ url_for('main_dashboard.dashboard') }}">Tableau de Bord</a></li>
                        <li class="breadcrumb-item active">Utilisateurs</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Liste des Utilisateurs -->
    <div class="row">
        <div class="col-12">
            <div class="glass-card">
                <div class="card-body">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-stretch gap-3 mb-4">
                        <div class="flex-grow-1">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" id="searchInput" class="form-control" placeholder="Rechercher un utilisateur...">
                            </div>
                        </div>
                        <div>
                            <button id="createUserBtn" class="btn btn-primary w-100">
                                <i class="fas fa-user-plus me-2"></i>
                                Créer un Utilisateur
                            </button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover" id="usersTable">
                            <thead>
                                <tr>
                                    <th class="text-nowrap">Nom d'affichage</th>
                                    <th class="text-nowrap">Nom d'utilisateur</th>
                                    <th class="text-nowrap">Rôle</th>
                                    <th class="text-nowrap">Zone</th>
                                    <th class="text-nowrap">Unité</th>
                                    <th class="text-nowrap">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td class="text-break">{{ user.nickname if user.nickname else '-' }}</td>
                                    <td><span class="badge bg-info text-break">{{ user.username }}</span></td>
                                    <td>
                                        {% if user.role == UserRole.ADMIN %}
                                            <span class="badge bg-danger text-wrap">{{ UserRole.get_role_display_name(user.role) }}</span>
                                        {% elif user.role == UserRole.EMPLOYEUR_DG %}
                                            <span class="badge bg-warning text-wrap">{{ UserRole.get_role_display_name(user.role) }}</span>
                                        {% elif user.role == UserRole.EMPLOYEUR_ZONE %}
                                            <span class="badge bg-primary text-wrap">{{ UserRole.get_role_display_name(user.role) }}</span>
                                        {% elif user.role == UserRole.EMPLOYEUR_UNITE %}
                                            <span class="badge bg-success text-wrap">{{ UserRole.get_role_display_name(user.role) }}</span>
                                        {% else %}
                                            <span class="badge bg-secondary text-wrap">{{ UserRole.get_role_display_name(user.role) }}</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-break">{{ user.assigned_zone.name if user.assigned_zone else '-' }}</td>
                                    <td class="text-break">{{ user.assigned_unit.name if user.assigned_unit else '-' }}</td>
                                    <td>
                                        <div class="actions-wrapper">
                                            <div class="actions-cell">
                                                <div class="actions-dropdown">
                                                    <button class="action-btn actions-toggle" type="button">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <div class="actions-menu">
                                                        <button class="action-btn btn-primary edit-user me-2" 
                                                                data-user-id="{{ user.id }}" 
                                                                data-username="{{ user.username }}"
                                                                data-nickname="{{ user.nickname }}"
                                                                data-role="{{ user.role }}"
                                                                data-zone="{{ user.assigned_zone.id if user.assigned_zone else '' }}"
                                                                data-unit="{{ user.assigned_unit.id if user.assigned_unit else '' }}"
                                                                data-bs-toggle="tooltip" 
                                                                title="Modifier l'utilisateur">
                                                            <i class="fas fa-edit"></i>
                                                            <span class="btn-text">Modifier</span>
                                                        </button>
                                                        <button class="action-btn btn-danger delete-user" 
                                                                data-user-id="{{ user.id }}" 
                                                                data-bs-toggle="tooltip" 
                                                                title="Supprimer l'utilisateur">
                                                            <i class="fas fa-trash"></i>
                                                            <span class="btn-text">Supprimer</span>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 mt-3">
                        <div class="text-muted order-2 order-md-1">
                            Affichage de <span id="startRange">1</span> à <span id="endRange">10</span> sur <span id="totalItems">{{ users|length }}</span> utilisateurs
                        </div>
                        <nav aria-label="Page navigation" class="order-1 order-md-2">
                            <ul class="pagination mb-0">
                                <li class="page-item">
                                    <button class="page-link" id="prevPage">Précédent</button>
                                </li>
                                <li class="page-item">
                                    <button class="page-link" id="nextPage">Suivant</button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Panel -->
<div id="userPanel" class="sliding-panel">
    <div class="panel-content">
        <div class="panel-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <i class="fas fa-user-plus me-2 text-primary"></i>
                <h3 class="mb-0" id="panelTitle">Créer un Utilisateur</h3>
            </div>
            <button id="closePanelBtn" class="btn-close"></button>
        </div>
        <div class="panel-body">
            <form id="createUserForm" class="needs-validation" novalidate>
                <!-- Username field -->
                <div class="mb-4">
                    <label for="username" class="form-label">Nom d'utilisateur <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-user"></i>
                        </span>
                        <input type="text" class="form-control" id="username" name="username" required 
                               minlength="3" pattern="[a-zA-Z0-9_-]+" 
                               placeholder="Entrez le nom d'utilisateur">
                    </div>
                    <div class="invalid-feedback">
                        Le nom d'utilisateur doit contenir au moins 3 caractères (lettres, chiffres, - ou _)
                    </div>
                    <small class="form-text text-muted">
                        Utilisé pour la connexion. Doit être unique.
                    </small>
                </div>

                <!-- Display name field -->
                <div class="mb-4">
                    <label for="nickname" class="form-label">Nom d'affichage <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-id-card"></i>
                        </span>
                        <input type="text" class="form-control" id="nickname" name="nickname" required 
                               minlength="2" placeholder="Entrez le nom d'affichage">
                    </div>
                    <div class="invalid-feedback">
                        Le nom d'affichage doit contenir au moins 2 caractères
                    </div>
                    <small class="form-text text-muted">
                        Nom affiché dans l'interface
                    </small>
                </div>

                <!-- Password field -->
                <div class="mb-4" id="passwordContainer">
                    <label for="password" class="form-label">Mot de passe <span class="text-danger password-required">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" class="form-control" id="password" name="password" required 
                               minlength="6" placeholder="Entrez le mot de passe">
                        <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="invalid-feedback">
                        Le mot de passe doit contenir au moins 6 caractères
                    </div>
                    <small class="form-text text-muted">
                        Minimum 6 caractères. Laissez vide pour conserver l'ancien mot de passe lors d'une modification.
                    </small>
                </div>

                <!-- Role field -->
                <div class="mb-4">
                    <label for="role" class="form-label">Rôle <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-user-tag"></i>
                        </span>
                        <select class="form-select" id="role" name="role" required>
                            <option value="">Sélectionner un rôle</option>
                            <option value="Admin">Admin</option>
                            <option value="Employeur DG">Employeur DG</option>
                            <option value="Employeur Zone">Employeur Zone</option>
                            <option value="Employeur Unité">Employeur Unité</option>
                            <option value="Utilisateur">Utilisateur</option>
                        </select>
                    </div>
                    <div class="invalid-feedback">
                        Veuillez sélectionner un rôle
                    </div>
                    <div class="form-text role-description"></div>
                </div>

                <!-- Zone selection -->
                <div class="mb-4" id="zoneContainer" style="display: none;">
                    <label for="zone_id" class="form-label">Zone <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-map-marker-alt"></i>
                        </span>
                        <select class="form-select" id="zone_id" name="zone_id">
                            <option value="">Sélectionnez une zone</option>
                            {% for zone in zones %}
                                <option value="{{ zone.id }}">{{ zone.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="invalid-feedback">
                        Veuillez sélectionner une zone
                    </div>
                    <small class="form-text text-muted">
                        La zone détermine le périmètre d'accès
                    </small>
                </div>

                <!-- Unit selection -->
                <div class="mb-4" id="unitContainer" style="display: none;">
                    <label for="unit_id" class="form-label">Unité <span class="text-danger">*</span></label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="fas fa-building"></i>
                        </span>
                        <select class="form-select" id="unit_id" name="unit_id">
                            <option value="">Sélectionnez d'abord une zone</option>
                        </select>
                    </div>
                    <div class="invalid-feedback">
                        Veuillez sélectionner une unité
                    </div>
                    <small class="form-text text-muted">
                        L'unité détermine le périmètre d'accès spécifique
                    </small>
                </div>

                <!-- Submit button -->
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2" role="status" aria-hidden="true"></span>
                        <i class="fas fa-save me-2"></i>
                        <span class="button-text">Créer l'utilisateur</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer cet utilisateur ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin/users.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/admin/users.js') }}"></script>
{% endblock %}
