{% extends "base/base.html" %}

{% block title %}Liste des Infrastructures{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
            <div class="position-sticky">
                <div class="sidebar-heading p-3 border-bottom">
                    <h5 class="mb-0">Infrastructures</h5>
                </div>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-filter="all">
                            <i class="fas fa-list me-2"></i>Toutes les Infrastructures
                        </a>
                    </li>
                    <li class="nav-item border-top mt-2 pt-2">
                        <h6 class="sidebar-heading px-3 mt-2 mb-1 text-muted">
                            <span>Types d'Infrastructures</span>
                        </h6>
                    </li>
                    {% for type in infrastructure_types %}
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-filter="{{ type }}">
                            <i class="fas fa-building me-2"></i>{{ type }}
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Liste des Infrastructures</h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-download me-1"></i>Exporter
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addInfrastructureModal">
                            <i class="fas fa-plus me-1"></i>Ajouter
                        </button>
                    </div>
                </div>
            </div>

            <!-- Infrastructures Table -->
            <div class="table-responsive">
                {% if infrastructures %}
                <table class="table table-striped table-hover" id="infrastructuresTable">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Type</th>
                            <th>Localisation</th>
                            <th>Capacité</th>
                            <th>État</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for infrastructure in infrastructures %}
                        <tr data-type="{{ infrastructure.type }}">
                            <td>{{ infrastructure.nom }}</td>
                            <td>{{ infrastructure.type }}</td>
                            <td>{{ infrastructure.localisation }}</td>
                            <td>{{ infrastructure.capacite }}</td>
                            <td>
                                <span class="badge {% if infrastructure.etat == 'Opérationnel' %}bg-success{% else %}bg-warning{% endif %}">
                                    {{ infrastructure.etat }}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-info view-infrastructure" title="Détails" data-infrastructure-id="{{ infrastructure.id }}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button type="button" class="btn btn-warning edit-infrastructure" title="Modifier" data-infrastructure-id="{{ infrastructure.id }}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="container mt-5">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="card text-center">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Aucune Infrastructure</h5>
                                    <p class="card-text text-muted mb-4">
                                        Il semble qu'il n'y ait pas d'infrastructures. 
                                        Commencez par créer de nouvelles infrastructures.
                                    </p>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addInfrastructureModal">
                                        <i class="fas fa-plus me-2"></i>Créer une Infrastructure
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>

<!-- Add Infrastructure Modal -->
<div class="modal fade" id="addInfrastructureModal" tabindex="-1" aria-labelledby="addInfrastructureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addInfrastructureModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Ajouter une Infrastructure
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addInfrastructureForm" novalidate enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="infrastructureNom" class="form-label">Nom de l'Infrastructure</label>
                            <input type="text" class="form-control" id="infrastructureNom" name="nom" required maxlength="200">
                            <div class="invalid-feedback">Veuillez saisir un nom (max 200 caractères)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="infrastructureType" class="form-label">Type d'Infrastructure</label>
                            <select class="form-select" id="infrastructureType" name="type" required>
                                <option value="">Sélectionner un type</option>
                                <option value="Station d'épuration">Station d'épuration</option>
                                <option value="Station de relevage">Station de relevage</option>
                                <option value="Station de pompage">Station de pompage</option>
                            </select>
                            <div class="invalid-feedback">Veuillez sélectionner un type</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="infrastructureLocalisation" class="form-label">Localisation</label>
                            <input type="text" class="form-control" id="infrastructureLocalisation" name="localisation" required maxlength="200">
                            <div class="invalid-feedback">Veuillez saisir une localisation (max 200 caractères)</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="infrastructureCapacite" class="form-label">Capacité</label>
                            <input type="number" step="0.01" class="form-control" id="infrastructureCapacite" name="capacite" required>
                            <div class="invalid-feedback">Veuillez saisir une capacité valide</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="infrastructureEtat" class="form-label">État</label>
                            <select class="form-select" id="infrastructureEtat" name="etat" required>
                                <option value="">Sélectionner un état</option>
                                <option value="Opérationnel">Opérationnel</option>
                                <option value="En Maintenance">En Maintenance</option>
                                <option value="Hors Service">Hors Service</option>
                            </select>
                            <div class="invalid-feedback">Veuillez sélectionner un état</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="infrastructureEpurationType" class="form-label">Type d'Épuration</label>
                            <input type="text" class="form-control" id="infrastructureEpurationType" name="epuration_type" maxlength="100">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="infrastructureFiles" class="form-label">Fichiers (Images/PDFs)</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="infrastructureFiles" name="files" multiple 
                                       accept=".jpg,.jpeg,.png,.gif,.pdf" 
                                       data-max-file-size="10485760" style="display: none;">
                                <button type="button" class="btn btn-outline-secondary" id="fileUploadTrigger">
                                    <i class="fas fa-upload me-2"></i>Sélectionner des fichiers
                                </button>
                                <button type="button" class="btn btn-primary" id="fileUploadConfirm" style="display: none;">
                                    <i class="fas fa-check me-2"></i>Confirmer le téléchargement
                                </button>
                            </div>
                            <div class="form-text text-muted">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Formats acceptés : JPG, PNG, GIF, PDF. Taille max : 10 Mo par fichier
                                </small>
                            </div>
                            <div id="filePreviewContainer" class="mt-2"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Enregistrer
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Infrastructure Modal -->
<div class="modal fade" id="editInfrastructureModal" tabindex="-1" aria-labelledby="editInfrastructureModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="editInfrastructureModalLabel">
                    <i class="fas fa-edit me-2"></i>Modifier l'Infrastructure
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editInfrastructureForm" novalidate enctype="multipart/form-data">
                <input type="hidden" id="editInfrastructureId" name="infrastructure_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editInfrastructureName" class="form-label">Nom de l'Infrastructure</label>
                            <input type="text" class="form-control" id="editInfrastructureName" name="nom" required maxlength="200">
                            <div class="invalid-feedback">Veuillez saisir un nom pour l'infrastructure.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editInfrastructureType" class="form-label">Type d'Infrastructure</label>
                            <select class="form-select" id="editInfrastructureType" name="type" required>
                                <option value="">Sélectionner un type</option>
                                <option value="Station d'épuration">Station d'épuration</option>
                                <option value="Station de relevage">Station de relevage</option>
                                <option value="Station de pompage">Station de pompage</option>
                            </select>
                            <div class="invalid-feedback">Veuillez sélectionner un type d'infrastructure.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editInfrastructureLocation" class="form-label">Localisation</label>
                            <input type="text" class="form-control" id="editInfrastructureLocation" name="localisation" required maxlength="200">
                            <div class="invalid-feedback">Veuillez saisir une localisation.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editInfrastructureCapacity" class="form-label">Capacité</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="editInfrastructureCapacity" name="capacite" 
                                       step="0.01" min="0" required>
                                <span class="input-group-text">m³</span>
                            </div>
                            <div class="invalid-feedback">Veuillez saisir une capacité valide.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editInfrastructureState" class="form-label">État</label>
                            <select class="form-select" id="editInfrastructureState" name="etat" required>
                                <option value="">Sélectionner un état</option>
                                <option value="Opérationnel">Opérationnel</option>
                                <option value="En Maintenance">En Maintenance</option>
                                <option value="Hors Service">Hors Service</option>
                            </select>
                            <div class="invalid-feedback">Veuillez sélectionner un état.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editInfrastructureEpurationType" class="form-label">Type d'Épuration</label>
                            <input type="text" class="form-control" id="editInfrastructureEpurationType" name="epuration_type" maxlength="100">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editInfrastructureFiles" class="form-label">Fichiers (Images/PDFs)</label>
                            <div class="input-group">
                                <input type="file" class="form-control" id="editInfrastructureFiles" name="files" multiple 
                                       accept=".jpg,.jpeg,.png,.gif,.pdf" 
                                       data-max-file-size="10485760" style="display: none;">
                                <button type="button" class="btn btn-outline-secondary" id="editFileUploadTrigger">
                                    <i class="fas fa-upload me-2"></i>Sélectionner des fichiers
                                </button>
                                <button type="button" class="btn btn-primary" id="editFileUploadConfirm" style="display: none;">
                                    <i class="fas fa-check me-2"></i>Confirmer le téléchargement
                                </button>
                            </div>
                            <div class="form-text text-muted">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Formats acceptés : JPG, PNG, GIF, PDF. Taille max : 10 Mo par fichier
                                </small>
                            </div>
                            <div id="editFilePreviewContainer" class="mt-2"></div>
                        </div>
                        <div class="col-md-6 mb-3" id="editExistingFilesContainer">
                            <label class="form-label">Fichiers existants</label>
                            <div class="row" id="editExistingFilesList">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Enregistrer les modifications
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Infrastructure Details Modal -->
<div class="modal fade" id="infrastructureDetailsModal" tabindex="-1" aria-labelledby="infrastructureDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="infrastructureDetailsModalLabel">
                    <i class="fas fa-building me-2"></i>Détails de l'Infrastructure
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-muted">Informations Générales</h6>
                        <table class="table table-borderless" id="infrastructureGeneralDetails">
                            <!-- General details will be populated here -->
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-muted">Détails Techniques</h6>
                        <table class="table table-borderless" id="infrastructureTechnicalDetails">
                            <!-- Technical details will be populated here -->
                        </table>
                    </div>
                </div>
                
                <!-- File Gallery Section -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-muted">Fichiers Associés</h6>
                        <div id="infrastructureFileGallery" class="infrastructure-file-gallery">
                            <!-- Files will be dynamically added here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Fermer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Full Screen Image/PDF Viewer Modal -->
<div class="modal fade" id="fileViewerModal" tabindex="-1" aria-labelledby="fileViewerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileViewerModalLabel">Visualisation du fichier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="fileViewerContent">
                <!-- File will be dynamically loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Existing file preview template -->
<template id="existingFileTemplate">
    <div class="gallery-item">
        <div class="gallery-item-inner">
            <div class="gallery-item-content">
                ${thumbnailContent}
                <div class="gallery-item-overlay">
                    <div class="gallery-item-actions">
                        <label class="btn btn-sm btn-outline-light delete-existing-file" 
                               data-file-id="${fileId}" 
                               data-file-name="${fileName}">
                            <i class="fas fa-trash"></i>
                        </label>
                        <a href="${fileUrl}" target="_blank" class="btn btn-sm btn-outline-light ms-2">
                            <i class="fas fa-eye"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="gallery-item-footer">
                <span class="gallery-item-name">${fileName}</span>
            </div>
        </div>
    </div>
</template>

<style>
    body {
        background-color: #f4f6f9;
    }
    .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        z-index: 100;
        padding: 48px 0 0;
        background-color: #2c3e50 !important; /* Dark background */
        color: #ecf0f1; /* Light text color */
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        width: 250px; /* Increased width for better readability */
    }
    .sidebar-heading {
        color: #bdc3c7 !important; /* Muted heading color */
        border-bottom: 1px solid rgba(255,255,255,0.1);
        padding: 1rem 1.25rem;
        margin-bottom: 1rem;
        font-size: 1.1rem;
    }
    .sidebar .nav {
        padding: 0 1rem; /* Add horizontal padding to nav */
    }
    .sidebar .nav-link {
        color: #ecf0f1 !important; /* Light text */
        font-weight: 500;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        border-radius: 6px;
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .sidebar .nav-link:hover {
        background-color: rgba(255,255,255,0.1);
        color: #3498db !important; /* Bright highlight on hover */
    }
    .sidebar .nav-link.active {
        background-color: rgba(52, 152, 219, 0.2);
        color: #3498db !important;
        font-weight: 600;
    }
    .sidebar .nav-item {
        margin-bottom: 0.5rem;
    }
    .sidebar .nav-item i {
        margin-right: 0.75rem;
        color: #bdc3c7;
        font-size: 1rem;
        width: 1.5rem; /* Consistent icon width */
        text-align: center;
    }
    .sidebar .nav-item:last-child {
        margin-bottom: 1rem;
    }
    .sidebar-heading + .nav-item {
        margin-top: 1rem;
    }
    .table-responsive {
        margin-top: 20px;
    }
    #infrastructuresTable {
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .btn-toolbar .btn {
        display: inline-flex;
        align-items: center;
    }
    .card-header {
        background-color: #f39c12 !important;
    }
    .card-body {
        padding: 2rem;
    }
    .card-title {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 1rem;
    }
    .card-text {
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 1.5rem;
    }
    .card {
        border: 1px solid #e0e0e0;
    }
    .card-body {
        padding: 2rem;
    }
    .card-title {
        color: #333;
        font-weight: 600;
    }
    .card-text {
        font-size: 1rem;
        line-height: 1.6;
    }

    /* iPhone-style file gallery */
    .infrastructure-file-gallery {
        display: flex;
        overflow-x: auto;
        gap: 10px;
        padding: 10px 0;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
    }

    .infrastructure-file-gallery .gallery-item {
        flex: 0 0 auto;
        width: 200px;
        height: 200px;
        border-radius: 10px;
        overflow: hidden;
        scroll-snap-align: center;
        position: relative;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .infrastructure-file-gallery .gallery-item:hover {
        transform: scale(1.05);
    }

    .infrastructure-file-gallery .gallery-item img,
    .infrastructure-file-gallery .gallery-item .pdf-placeholder {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .infrastructure-file-gallery .gallery-item .pdf-placeholder {
        background-color: #e74c3c;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
    }

    .infrastructure-file-gallery .gallery-item .file-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.5);
        color: white;
        padding: 5px;
        text-align: center;
        font-size: 0.8rem;
    }

    .file-preview {
        border: 1px dashed #ccc;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
    }

    .file-preview-item {
        position: relative;
        display: inline-block;
        margin: 5px;
    }

    .pdf-preview {
        width: 100px;
        height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }

    .file-preview-item {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

    .file-preview-item img,
    .file-preview-item .pdf-preview {
        margin-right: 15px;
    }

    .file-info {
        display: flex;
        align-items: center;
    }

    .remove-file {
        margin-left: auto;
    }

    .existing-file {
        background-color: #f8f9fa;
        border-radius: 5px;
        padding: 10px;
        margin-bottom: 10px;
        align-items: center;
    }

    .existing-file .file-preview {
        margin-right: 15px;
    }

    .existing-file .file-details {
        flex-grow: 1;
    }

    .remove-existing-file {
        margin-left: auto;
    }

    .file-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        position: relative;
    }

    .file-card:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 6px rgba(0,0,0,0.1) !important;
    }

    .file-card .remove-existing-file {
        position: absolute;
        top: 10px;
        left: 10px;
        z-index: 10;
    }

    .file-card .file-icon {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100px;
    }

    .file-card .card-title {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    #editExistingFilesList {
        max-height: 400px;
        overflow-y: auto;
    }

    .thumbnail-container {
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        transition: transform 0.2s;
    }

    .thumbnail-container:hover {
        transform: scale(1.05);
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .thumbnail-image {
        height: 150px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        border-radius: 3px;
    }

    .thumbnail-image img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
    }

    .thumbnail-image.pdf-preview {
        background-color: #f0f0f0;
        color: #333;
    }

    .remove-existing-file {
        z-index: 10;
    }

    #editExistingFilesList {
        max-height: 400px;
        overflow-y: auto;
    }

    /* Modern File Grid Styles */
    #editExistingFilesList {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
        background-color: #f8f9fa;
    }

    .file-grid-item {
        position: relative;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        background-color: white;
    }

    .file-grid-item:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 15px rgba(0,0,0,0.15);
    }

    .file-grid-thumbnail {
        position: relative;
        height: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        background-color: #f1f3f5;
    }

    .file-grid-thumbnail img {
        max-width: 100%;
        max-height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .file-grid-thumbnail .pdf-preview {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        height: 100%;
        background-color: #f8f9fa;
    }

    .file-grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .file-grid-item:hover .file-grid-overlay {
        opacity: 1;
    }

    .file-grid-actions {
        display: flex;
        justify-content: center;
    }

    .file-grid-actions .btn {
        margin: 0 5px;
    }

    .remove-existing-file {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .file-grid-details {
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f1f3f5;
    }

    .file-grid-name {
        font-weight: 600;
        max-width: 70%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-grid-size {
        color: #6c757d;
        font-size: 0.8em;
    }

    /* Masonry Grid Styles */
    #editExistingFilesList {
        column-count: 4;
        column-gap: 15px;
        max-height: 500px;
        overflow-y: auto;
        padding: 10px;
        background-color: #f8f9fa;
    }

    .gallery-item {
        break-inside: avoid;
        margin-bottom: 15px;
        background-color: white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .gallery-item:hover {
        transform: scale(1.03);
    }

    .gallery-item-inner {
        position: relative;
    }

    .gallery-item-content {
        position: relative;
        overflow: hidden;
    }

    .gallery-item-content img {
        width: 100%;
        height: auto;
        display: block;
        object-fit: cover;
    }

    .gallery-item-content .pdf-preview {
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #f1f3f5;
        height: 200px;
    }

    .gallery-item-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .gallery-item:hover .gallery-item-overlay {
        opacity: 1;
    }

    .gallery-item-actions {
        display: flex;
        justify-content: center;
    }

    .remove-existing-file {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .gallery-item-footer {
        padding: 8px;
        background-color: #f8f9fa;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .gallery-item-name {
        font-size: 0.9em;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* Responsive Adjustments */
    @media (max-width: 1200px) {
        #editExistingFilesList {
            column-count: 3;
        }
    }

    @media (max-width: 992px) {
        #editExistingFilesList {
            column-count: 2;
        }
    }

    @media (max-width: 576px) {
        #editExistingFilesList {
            column-count: 1;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sidebarLinks = document.querySelectorAll('#sidebar .nav-link');
        const infrastructureRows = document.querySelectorAll('#infrastructuresTable tbody tr');

        sidebarLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active from all links
                sidebarLinks.forEach(l => l.classList.remove('active'));
                this.classList.add('active');

                const filter = this.getAttribute('data-filter');

                infrastructureRows.forEach(row => {
                    if (filter === 'all' || row.getAttribute('data-type') === filter) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });

        // Modal and Form Handling
        const addInfrastructureModal = new bootstrap.Modal(document.getElementById('addInfrastructureModal'));
        const addInfrastructureForm = document.getElementById('addInfrastructureForm');
        const infrastructureFiles = document.getElementById('infrastructureFiles');
        const fileUploadTrigger = document.getElementById('fileUploadTrigger');
        const fileUploadConfirm = document.getElementById('fileUploadConfirm');
        const filePreviewContainer = document.getElementById('filePreviewContainer');

        // Trigger hidden file input when upload button is clicked
        fileUploadTrigger.addEventListener('click', function() {
            infrastructureFiles.click();
        });

        infrastructureFiles.addEventListener('change', function(e) {
            const files = e.target.files;
            
            // Clear previous previews
            filePreviewContainer.innerHTML = '';

            if (files.length > 0) {
                // Show confirm button
                fileUploadConfirm.style.display = 'inline-block';
                
                // Create preview for each file
                Array.from(files).forEach(file => {
                    const filePreview = document.createElement('div');
                    filePreview.classList.add('file-preview-item', 'me-2', 'mb-2', 'd-flex', 'align-items-center');
                    
                    let previewContent = '';
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.classList.add('img-thumbnail', 'me-2');
                            img.style.maxWidth = '100px';
                            img.style.maxHeight = '100px';
                            filePreview.insertBefore(img, filePreview.firstChild);
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        previewContent = `
                            <div class="pdf-preview bg-danger text-white p-2 rounded me-2">
                                <i class="fas fa-file-pdf fa-2x"></i>
                            </div>
                        `;
                        filePreview.innerHTML = previewContent;
                    }

                    // Add file name and size
                    const fileInfo = document.createElement('div');
                    fileInfo.classList.add('file-info');
                    fileInfo.innerHTML = `
                        <strong>${file.name}</strong>
                        <small class="text-muted ms-2">(${(file.size / 1024).toFixed(2)} Ko)</small>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-file" data-filename="${file.name}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    filePreview.appendChild(fileInfo);

                    filePreviewContainer.appendChild(filePreview);
                });

                // Add event listeners to remove file buttons
                filePreviewContainer.querySelectorAll('.remove-file').forEach(button => {
                    button.addEventListener('click', function() {
                        const filename = this.getAttribute('data-filename');
                        const fileInput = document.getElementById('infrastructureFiles');
                        
                        // Create a new FileList without the removed file
                        const updatedFiles = Array.from(fileInput.files)
                            .filter(file => file.name !== filename);
                        
                        // Create a new FileList
                        const dataTransfer = new DataTransfer();
                        updatedFiles.forEach(file => dataTransfer.items.add(file));
                        
                        fileInput.files = dataTransfer.files;
                        
                        // Remove the preview
                        this.closest('.file-preview-item').remove();

                        // Hide confirm button if no files
                        if (fileInput.files.length === 0) {
                            fileUploadConfirm.style.display = 'none';
                        }
                    });
                });
            } else {
                // Hide confirm button if no files
                fileUploadConfirm.style.display = 'none';
            }
        });

        // Confirm upload button
        fileUploadConfirm.addEventListener('click', function() {
            // Trigger form submission
            addInfrastructureForm.dispatchEvent(new Event('submit'));
        });

        addInfrastructureForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();

            if (addInfrastructureForm.checkValidity()) {
                const formData = new FormData(addInfrastructureForm);

                // Validate file sizes
                let validFiles = true;
                const infrastructureFiles = document.getElementById('infrastructureFiles');
                
                // Check new file uploads
                Array.from(infrastructureFiles.files).forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {  // 10 MB limit
                        validFiles = false;
                        alert(`Le fichier ${file.name} dépasse la limite de 10 Mo.`);
                    }
                });

                if (!validFiles) {
                    return;
                }

                // AJAX submission to backend route
                fetch('/departement/exploitation/infrastructures/create', {  
                    method: 'POST',
                    body: formData  // Send as multipart/form-data
                })
                .then(response => {
                    if (!response.ok) {
                        // Log the full response for debugging
                        return response.text().then(text => {
                            console.error('Server response:', text);
                            throw new Error('Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message
                        let successMessage = `Infrastructure créée avec succès. 
                            ${data.files_uploaded > 0 ? `${data.files_uploaded} fichier(s) téléchargé(s)` : 'Aucun fichier téléchargé'}`;
                        
                        alert(successMessage);
                        
                        // Refresh page or update table dynamically
                        location.reload();
                    } else {
                        // Show error message
                        alert(data.message || 'Erreur lors de la création de l\'infrastructure');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de la création de l\'infrastructure');
                });
            } else {
                addInfrastructureForm.classList.add('was-validated');
            }
        });

        // Infrastructure Details Modal Handling
        const infrastructureDetailsModal = new bootstrap.Modal(document.getElementById('infrastructureDetailsModal'));
        const infrastructureGeneralDetails = document.getElementById('infrastructureGeneralDetails');
        const infrastructureTechnicalDetails = document.getElementById('infrastructureTechnicalDetails');
        const infrastructureFileGallery = document.getElementById('infrastructureFileGallery');
        const fileViewerModal = new bootstrap.Modal(document.getElementById('fileViewerModal'));
        const fileViewerContent = document.getElementById('fileViewerContent');

        const viewButtons = document.querySelectorAll('.view-infrastructure');

        viewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const infrastructureId = this.getAttribute('data-infrastructure-id');
                
                // Fetch infrastructure details
                fetch(`/departement/exploitation/infrastructures/${infrastructureId}/details`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Clear previous details
                        infrastructureGeneralDetails.innerHTML = '';
                        infrastructureTechnicalDetails.innerHTML = '';
                        infrastructureFileGallery.innerHTML = '';

                        // Populate general details
                        infrastructureGeneralDetails.innerHTML = `
                            <tr>
                                <th>Nom</th>
                                <td>${data.nom}</td>
                            </tr>
                            <tr>
                                <th>Type</th>
                                <td>${data.type}</td>
                            </tr>
                            <tr>
                                <th>Localisation</th>
                                <td>${data.localisation}</td>
                            </tr>
                        `;

                        // Populate technical details
                        infrastructureTechnicalDetails.innerHTML = `
                            <tr>
                                <th>Capacité</th>
                                <td>${data.capacite}</td>
                            </tr>
                            <tr>
                                <th>État</th>
                                <td>
                                    <span class="badge ${data.etat === 'Opérationnel' ? 'bg-success' : 'bg-warning'}">
                                        ${data.etat}
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <th>Type d'Épuration</th>
                                <td>${data.epuration_type || 'N/A'}</td>
                            </tr>
                        `;

                        // Populate file gallery
                        if (data.files && data.files.length > 0) {
                            data.files.forEach(file => {
                                const galleryItem = document.createElement('div');
                                galleryItem.classList.add('gallery-item');
                                
                                let filePreview = '';
                                if (file.file_type === 'image') {
                                    filePreview = `<img src="${file.filepath}" alt="${file.filename}">`;
                                } else if (file.file_type === 'pdf') {
                                    filePreview = `
                                        <div class="pdf-placeholder">
                                            <i class="fas fa-file-pdf fa-2x"></i>
                                        </div>
                                    `;
                                }

                                galleryItem.innerHTML = `
                                    ${filePreview}
                                    <div class="file-info">${file.filename}</div>
                                `;

                                // Add click event to view file
                                galleryItem.addEventListener('click', () => {
                                    fileViewerContent.innerHTML = '';
                                    if (file.file_type === 'image') {
                                        fileViewerContent.innerHTML = `
                                            <img src="${file.filepath}" class="img-fluid" style="max-height: 90vh;">
                                        `;
                                    } else if (file.file_type === 'pdf') {
                                        fileViewerContent.innerHTML = `
                                            <iframe src="${file.filepath}" width="100%" height="90%" frameborder="0"></iframe>
                                        `;
                                    }
                                    fileViewerModal.show();
                                });

                                infrastructureFileGallery.appendChild(galleryItem);
                            });
                        } else {
                            infrastructureFileGallery.innerHTML = `
                                <div class="alert alert-info w-100">
                                    Aucun fichier associé à cette infrastructure.
                                </div>
                            `;
                        }
                        
                        infrastructureDetailsModal.show();
                    })
                    .catch(error => {
                        console.error('Error fetching infrastructure details:', error);
                        alert('Impossible de charger les détails de l\'infrastructure');
                    });
            });
        });

        // Edit Infrastructure Modal Handling
        const editInfrastructureModal = new bootstrap.Modal(document.getElementById('editInfrastructureModal'));
        const editInfrastructureForm = document.getElementById('editInfrastructureForm');
        const editInfrastructureId = document.getElementById('editInfrastructureId');
        const editInfrastructureName = document.getElementById('editInfrastructureName');
        const editInfrastructureType = document.getElementById('editInfrastructureType');
        const editInfrastructureLocation = document.getElementById('editInfrastructureLocation');
        const editInfrastructureCapacity = document.getElementById('editInfrastructureCapacity');
        const editInfrastructureState = document.getElementById('editInfrastructureState');
        const editInfrastructureEpurationType = document.getElementById('editInfrastructureEpurationType');
        
        const editInfrastructureFiles = document.getElementById('editInfrastructureFiles');
        const editFileUploadTrigger = document.getElementById('editFileUploadTrigger');
        const editFileUploadConfirm = document.getElementById('editFileUploadConfirm');
        const editFilePreviewContainer = document.getElementById('editFilePreviewContainer');
        const editExistingFilesContainer = document.getElementById('editExistingFilesContainer');
        const editExistingFilesList = document.getElementById('editExistingFilesList');

        // Simplified edit modal handling
        function openEditModal(infrastructureData) {
            // Populate form fields
            document.getElementById('editInfrastructureId').value = infrastructureData.id;
            document.getElementById('editInfrastructureName').value = infrastructureData.nom;
            document.getElementById('editInfrastructureType').value = infrastructureData.type;
            document.getElementById('editInfrastructureLocation').value = infrastructureData.localisation;
            document.getElementById('editInfrastructureCapacity').value = infrastructureData.capacite;
            document.getElementById('editInfrastructureState').value = infrastructureData.etat;
            document.getElementById('editInfrastructureEpurationType').value = infrastructureData.epuration_type || '';

            // Clear existing files preview
            const editExistingFilesList = document.getElementById('editExistingFilesList');
            const editFilePreviewContainer = document.getElementById('editFilePreviewContainer');
            const editFileUploadConfirm = document.getElementById('editFileUploadConfirm');
            
            editExistingFilesList.innerHTML = '';
            editFilePreviewContainer.innerHTML = '';
            editFileUploadConfirm.style.display = 'none';

            // Display existing files
            const editExistingFilesContainer = document.getElementById('editExistingFilesContainer');
            if (infrastructureData.files && infrastructureData.files.length > 0) {
                console.log('Existing files:', infrastructureData.files);
                infrastructureData.files.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.classList.add('gallery-item');
                    
                    const template = document.getElementById('existingFileTemplate');
                    
                    let thumbnailContent = '';
                    
                    if (file.file_type === 'image') {
                        // Image thumbnail
                        thumbnailContent = `
                            <img src="${file.filepath}" alt="${file.filename}">
                        `;
                    } else {
                        // PDF or other file type preview
                        thumbnailContent = `
                            <div class="pdf-preview">
                                <i class="fas fa-file-pdf fa-3x text-danger"></i>
                            </div>
                        `;
                    }
                    
                    // Replace template placeholders
                    const fileHtml = template.innerHTML
                        .replace('${fileId}', file.id)
                        .replace('${fileName}', file.filename)
                        .replace('${thumbnailContent}', thumbnailContent)
                        .replace('${fileUrl}', file.filepath);
                    
                    fileItem.innerHTML = fileHtml;
                    editExistingFilesList.appendChild(fileItem);
                });
                
                // Ensure the container is visible
                editExistingFilesContainer.style.display = 'block';
            } else {
                console.log('No existing files found:', infrastructureData);
                // Hide existing files container if no files
                editExistingFilesContainer.style.display = 'none';
            }

            // Open the modal
            const editInfrastructureModal = new bootstrap.Modal(document.getElementById('editInfrastructureModal'));
            editInfrastructureModal.show();
        }

        // Trigger hidden file input when upload button is clicked
        editFileUploadTrigger.addEventListener('click', function() {
            editInfrastructureFiles.click();
        });

        // File selection and preview for edit modal
        editInfrastructureFiles.addEventListener('change', function(e) {
            const files = e.target.files;
            
            // Clear previous previews
            editFilePreviewContainer.innerHTML = '';

            if (files.length > 0) {
                // Show confirm button
                editFileUploadConfirm.style.display = 'inline-block';
                
                // Create preview for each file
                Array.from(files).forEach(file => {
                    const filePreview = document.createElement('div');
                    filePreview.classList.add('file-preview-item', 'me-2', 'mb-2', 'd-flex', 'align-items-center');
                    
                    let previewContent = '';
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.classList.add('img-thumbnail', 'me-2');
                            img.style.maxWidth = '100px';
                            img.style.maxHeight = '100px';
                            filePreview.insertBefore(img, filePreview.firstChild);
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                        previewContent = `
                            <div class="pdf-preview bg-danger text-white p-2 rounded me-2">
                                <i class="fas fa-file-pdf fa-2x"></i>
                            </div>
                        `;
                        filePreview.innerHTML = previewContent;
                    }

                    // Add file name and size
                    const fileInfo = document.createElement('div');
                    fileInfo.classList.add('file-info');
                    fileInfo.innerHTML = `
                        <strong>${file.name}</strong>
                        <small class="text-muted ms-2">(${(file.size / 1024).toFixed(2)} Ko)</small>
                        <button type="button" class="btn btn-sm btn-outline-danger ms-2 remove-file" data-filename="${file.name}">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    filePreview.appendChild(fileInfo);

                    editFilePreviewContainer.appendChild(filePreview);
                });

                // Add event listeners to remove file buttons
                editFilePreviewContainer.querySelectorAll('.remove-file').forEach(button => {
                    button.addEventListener('click', function() {
                        const filename = this.getAttribute('data-filename');
                        const fileInput = document.getElementById('editInfrastructureFiles');
                        
                        // Create a new FileList without the removed file
                        const updatedFiles = Array.from(fileInput.files)
                            .filter(file => file.name !== filename);
                        
                        // Create a new FileList
                        const dataTransfer = new DataTransfer();
                        updatedFiles.forEach(file => dataTransfer.items.add(file));
                        
                        fileInput.files = dataTransfer.files;
                        
                        // Remove the preview
                        this.closest('.file-preview-item').remove();

                        // Hide confirm button if no files
                        if (fileInput.files.length === 0) {
                            editFileUploadConfirm.style.display = 'none';
                        }
                    });
                });
            } else {
                // Hide confirm button if no files
                editFileUploadConfirm.style.display = 'none';
            }
        });

        // Confirm upload button for edit modal
        editFileUploadConfirm.addEventListener('click', function() {
            // Trigger form submission
            editInfrastructureForm.dispatchEvent(new Event('submit'));
        });

        // Existing file deletion functionality
        editExistingFilesList.addEventListener('click', function(e) {
            // Check for delete button or image within gallery item
            const deleteButton = e.target.closest('.delete-existing-file');
            const imageItem = e.target.closest('.gallery-item');
            
            if (deleteButton || (imageItem && e.target.closest('.gallery-item-content'))) {
                // If clicked on image, find the associated delete button
                const targetDeleteButton = deleteButton || 
                    imageItem.querySelector('.delete-existing-file');
                
                const fileItem = targetDeleteButton.closest('.gallery-item');
                const fileId = targetDeleteButton.getAttribute('data-file-id');
                const fileName = targetDeleteButton.getAttribute('data-file-name');
                
                // Create a more informative confirmation dialog
                const confirmDelete = confirm(`Voulez-vous vraiment supprimer le fichier "${fileName}" ?`);
                
                if (confirmDelete) {
                    // Add visual feedback
                    fileItem.classList.add('bg-danger', 'text-white');
                    fileItem.style.opacity = '0.5';
                    
                    // Remove file from UI
                    setTimeout(() => {
                        fileItem.remove();
                    }, 300);
                    
                    // Create hidden input for backend processing
                    const hiddenDeletedFile = document.createElement('input');
                    hiddenDeletedFile.type = 'hidden';
                    hiddenDeletedFile.name = 'deleted_files[]';
                    hiddenDeletedFile.value = fileId;
                    hiddenDeletedFile.classList.add('deleted-file-input');
                    
                    // Remove any previous hidden inputs for this file
                    const existingHiddenInput = editInfrastructureForm.querySelector(
                        `.deleted-file-input[value="${fileId}"]`
                    );
                    if (existingHiddenInput) {
                        existingHiddenInput.remove();
                    }
                    
                    // Append new hidden input
                    editInfrastructureForm.appendChild(hiddenDeletedFile);
                }
            }
        });

        // Edit Infrastructure Form Submission
        editInfrastructureForm.addEventListener('submit', function(e) {
            e.preventDefault();
            e.stopPropagation();

            if (editInfrastructureForm.checkValidity()) {
                const formData = new FormData(editInfrastructureForm);

                // Validate file sizes
                let validFiles = true;
                const editInfrastructureFiles = document.getElementById('editInfrastructureFiles');
                
                // Check new file uploads
                Array.from(editInfrastructureFiles.files).forEach(file => {
                    if (file.size > 10 * 1024 * 1024) {  // 10 MB limit
                        validFiles = false;
                        alert(`Le fichier ${file.name} dépasse la limite de 10 Mo.`);
                    }
                });

                if (!validFiles) {
                    return;
                }

                // Collect IDs of files to be deleted (OPTIONAL)
                const filesToDelete = Array.from(
                    editExistingFilesList.querySelectorAll('.remove-existing-file')
                ).map(button => button.getAttribute('data-file-id'));
                
                // Add deleted files to form data ONLY IF user explicitly checks them
                if (filesToDelete.length > 0) {
                    formData.append('deleted_files', JSON.stringify(filesToDelete));
                }

                // AJAX submission to backend route
                fetch(`/departement/exploitation/infrastructures/${editInfrastructureId.value}/edit`, {  
                    method: 'POST',
                    body: formData  // Send as multipart/form-data
                })
                .then(response => {
                    if (!response.ok) {
                        // Log the full response for debugging
                        return response.text().then(text => {
                            console.error('Server response:', text);
                            throw new Error('Network response was not ok');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message
                        let successMessage = `Infrastructure mise à jour avec succès. 
                            ${data.files_uploaded > 0 ? `${data.files_uploaded} fichier(s) téléchargé(s)` : ''}
                            ${data.files_deleted > 0 ? `${data.files_deleted} fichier(s) supprimé(s)` : ''}`;
                        
                        alert(successMessage);
                        
                        // Refresh page or update table dynamically
                        location.reload();
                    } else {
                        // Show error message
                        alert(data.message || 'Erreur lors de la mise à jour de l\'infrastructure');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Une erreur est survenue lors de la mise à jour de l\'infrastructure');
                });
            } else {
                editInfrastructureForm.classList.add('was-validated');
            }
        });

        // Attach openEditModal to global scope so it can be called from other scripts
        window.openEditModal = openEditModal;

        // Edit button click event
        const editButtons = document.querySelectorAll('.edit-infrastructure');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                const infrastructureId = this.getAttribute('data-infrastructure-id');
                
                // Fetch infrastructure details
                fetch(`/departement/exploitation/infrastructures/${infrastructureId}/details`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        openEditModal(data);
                    })
                    .catch(error => {
                        console.error('Error fetching infrastructure details:', error);
                        alert('Impossible de charger les détails de l\'infrastructure');
                    });
            });
        });
    });
</script>

<script>
    function renderExistingFiles(infrastructureData) {
        const editExistingFilesList = document.getElementById('editExistingFilesList');
        editExistingFilesList.innerHTML = ''; // Clear existing files

        if (infrastructureData.files && infrastructureData.files.length > 0) {
            infrastructureData.files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.classList.add('gallery-item');
                
                const template = document.getElementById('existingFileTemplate');
                
                let thumbnailContent = '';
                
                if (file.file_type === 'image') {
                    // Image thumbnail
                    thumbnailContent = `
                        <img src="${file.filepath}" alt="${file.filename}">
                    `;
                } else {
                    // PDF or other file type preview
                    thumbnailContent = `
                        <div class="pdf-preview">
                            <i class="fas fa-file-pdf fa-3x text-danger"></i>
                        </div>
                    `;
                }
                
                // Replace template placeholders
                const fileHtml = template.innerHTML
                    .replace('${fileId}', file.id)
                    .replace('${fileName}', file.filename)
                    .replace('${thumbnailContent}', thumbnailContent)
                    .replace('${fileUrl}', file.filepath);
                
                fileItem.innerHTML = fileHtml;
                editExistingFilesList.appendChild(fileItem);
            });
        }
    }

    // Update the openEditModal function to use the new rendering
    function openEditModal(infrastructureData) {
        // Existing code...
        renderExistingFiles(infrastructureData);
        // Rest of the existing code...
    }
</script>
{% endblock %}
